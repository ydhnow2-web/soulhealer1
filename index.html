<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Healer | ì˜í˜¼ì˜ ìª½ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Outfit:wght@300;400;600&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f172a;
            --post-it: #fef9a7;
            --tape: rgba(255, 255, 255, 0.4);
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .handwriting { font-family: 'Nanum Pen Script', cursive; }
        .mystic-bg {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a),
                        radial-gradient(circle at bottom left, #312e81, #0f172a);
        }
        .post-it {
            background-color: var(--post-it);
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.5);
            transform: rotate(-1.5deg);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .post-it:hover { transform: rotate(0deg) scale(1.02); }
        .tape {
            background-color: var(--tape);
            width: 120px; height: 35px;
            position: absolute; top: -18px; left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        .btn-glow:hover {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }
        .note-content::-webkit-scrollbar { width: 4px; }
        .note-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
    </style>
</head>
<body class="mystic-bg min-h-screen flex items-center justify-center p-6 text-center">

    <div class="w-full max-w-lg z-10">
        <!-- ì…ë ¥ ì˜ì—­ -->
        <div id="input-container" class="fade-in space-y-10">
            <header>
                <h1 class="text-3xl font-light tracking-[0.3em] text-indigo-300 mb-2 uppercase">Soul Healer</h1>
                <p class="text-indigo-200/40 text-[10px] tracking-widest uppercase font-bold">Healing Engine Signature</p>
            </header>

            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[40px] p-10 shadow-2xl">
                <p class="text-indigo-100/70 mb-8 text-sm font-light italic leading-relaxed">
                    "ì˜¤ëŠ˜ ê·¸ëŒ€ì˜ ë§ˆìŒì´ ì–´ë– í•œê°€ìš”? <br> ëˆ„êµ°ê°€ì—ê²Œ í„¸ì–´ë†“ì•„ ë³´ì„¸ìš”."
                </p>
                <textarea id="user-worry" rows="3" 
                    class="w-full bg-transparent border-b border-indigo-500/20 text-white text-center text-xl placeholder-indigo-300/10 focus:outline-none focus:border-indigo-400 transition-all resize-none mb-10"
                    placeholder="ì‚¬ì‹¤ ì € ì˜¤ëŠ˜ ì¢€ ì§€ì³¤ì–´ìš”..."></textarea>
                
                <button onclick="startHealing()" id="btn-submit"
                    class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold tracking-widest hover:shadow-lg hover:shadow-indigo-500/30 transition-all active:scale-95">
                    ìª½ì§€ ë‚¨ê¸°ê¸°
                </button>
            </div>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ (í¬ìŠ¤íŠ¸ì‡) -->
        <div id="result-container" class="hidden flex flex-col items-center">
            <div id="healer-note" class="post-it relative p-10 w-full min-h-[480px] flex flex-col justify-between text-gray-800 text-left fade-in">
                <div class="tape"></div>
                
                <div class="flex justify-between items-start handwriting text-2xl text-blue-700/70">
                    <span id="note-header">ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ ì•„ì´ì—ê²Œ,</span>
                    <span id="note-date" class="text-gray-400 text-lg"></span>
                </div>

                <div id="note-body" class="handwriting text-3xl leading-[1.6] py-6 flex-grow overflow-y-auto note-content">
                    <!-- AI ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤ -->
                </div>

                <div class="flex justify-between items-end">
                    <button id="btn-play" onclick="playVoice()" class="w-12 h-12 bg-black/5 hover:bg-black/10 rounded-full flex items-center justify-center transition-all">
                        <span id="speaker-icon" class="text-xl">ğŸ”Š</span>
                    </button>
                    <div class="text-right">
                        <span id="note-signature" class="handwriting text-4xl text-red-500/80"></span>
                    </div>
                </div>
            </div>

            <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="mt-12 flex flex-col sm:flex-row gap-4 w-full fade-in">
                <button onclick="resetApp()" 
                    class="flex-1 px-6 py-4 bg-white/5 hover:bg-white/10 text-indigo-200 border border-white/10 rounded-2xl text-xs font-bold tracking-widest uppercase transition-all">
                    ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button onclick="startHealing(true)" 
                    class="flex-1 px-6 py-4 bg-indigo-600/30 hover:bg-indigo-600/50 text-white border border-indigo-500/30 rounded-2xl text-xs font-bold tracking-widest uppercase shadow-lg transition-all transform hover:-translate-y-0.5 btn-glow">
                    ë‹¤ë¥¸ ë©”ì‹œì§€ ë“£ê¸°
                </button>
            </div>
        </div>

        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <div id="global-loader" class="hidden fixed inset-0 bg-slate-950/85 backdrop-blur-md z-50 flex flex-col items-center justify-center text-center">
            <div class="w-14 h-14 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin mb-6"></div>
            <p id="loader-msg" class="text-indigo-300 text-xs tracking-[0.2em] font-light uppercase loading-dots">ì§„ì‹¬ì„ ë‹´ì•„ ì ê³  ìˆì–´ìš”</p>
        </div>
    </div>

    <script>
        // ë¡œì»¬ ì‹¤í–‰ ì‹œ ì‚¬ë ¹ê´€ë‹˜ì˜ API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
        // Vercel ë“± ë°°í¬ í™˜ê²½ì—ì„œëŠ” ë¹„ì›Œë‘ì–´ë„ ìë™ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤.
        let localApiKey = ""; 

        let audioBlob = null;
        let isProcessing = false;
        let lastPersonaIdx = -1;

        const personas = [
            {
                name: "ë‹¤ì •í•œ ì•„ë¹ ",
                header: "ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ ë”¸ì—ê²Œ,",
                signature: "papa.",
                voiceStyle: "ë”°ëœ»í•˜ê³  ì¸ìí•œ ì•„ë¹ ì˜ ëª©ì†Œë¦¬",
                voiceName: "Fenrir",
                prompt: "ì‚¬ìš©ìë¥¼ 'ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•œ 7ì‚´ ë”¸'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ë§íˆ¬ëŠ” ~í•˜ë ´, ~ë‹¨ë‹¤. ë¬¸ê°€ì˜ ì•„ë²„ë‹˜ ìŠ¤íƒ€ì¼."
            },
            {
                name: "í¬ê·¼í•œ ì—„ë§ˆ",
                header: "ë‚˜ì˜ ì˜ˆìœ ê°•ì•„ì§€ì—ê²Œ,",
                signature: "mom.",
                voiceStyle: "ë‹¤ì •í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì—„ë§ˆì˜ ëª©ì†Œë¦¬",
                voiceName: "Kore",
                prompt: "ì‚¬ìš©ìë¥¼ 'ëˆˆì— ë„£ì–´ë„ ì•ˆ ì•„í”ˆ ìì‹'ìœ¼ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ë§íˆ¬ëŠ” ~í•´, ~í–ˆë‹ˆ?, ì—„ë§ˆê°€ í•­ìƒ ì‚¬ë‘í•´."
            },
            {
                name: "ì§€í˜œë¡œìš´ í• ë¨¸ë‹ˆ",
                header: "ê·€í•œ ìš°ë¦¬ ê°•ì•„ì§€ ë³´ì•„ë¼,",
                signature: "Grandma.",
                voiceStyle: "ì¸ìí•˜ê³  ëŠë¦¿í•œ í• ë¨¸ë‹ˆ ëª©ì†Œë¦¬",
                voiceName: "Leda",
                prompt: "ì‚¬ìš©ìë¥¼ 'ì• í‹‹í•œ ì†ì£¼'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. íˆ¬ë°•í•˜ì§€ë§Œ ë”°ëœ»í•œ ë§íˆ¬, ~í–ˆë‹ˆ?, ê³ ìƒ ë§ì•˜ë‹¤."
            },
            {
                name: "ìˆ˜í˜¸ì²œì‚¬",
                header: "ì§€ìƒì—ì„œ ë¹›ë‚˜ëŠ” ì˜í˜¼ì—ê²Œ,",
                signature: "Angel.",
                voiceStyle: "ì‹ ë¹„ë¡­ê³  í‰ì˜¨í•œ ëª©ì†Œë¦¬",
                voiceName: "Aoede",
                prompt: "ì‚¬ìš©ìë¥¼ 'ë³´í˜¸ë°›ì•„ì•¼ í•  ì¡´ê·€í•œ ì˜í˜¼'ìœ¼ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ê²©ì‹ ìˆê³  í‰ì˜¨í•œ ë§íˆ¬."
            },
            {
                name: "ë¯¸ë˜ì˜ ë‚˜",
                header: "ê³¼ê±°ë¥¼ ê²¬ë””ê³  ìˆëŠ” ë‚˜ì—ê²Œ,",
                signature: "Future Me.",
                voiceStyle: "ì°¨ë¶„í•˜ê³  í™•ì‹ ì— ì°¬ ëª©ì†Œë¦¬",
                voiceName: "Zephyr",
                prompt: "ì‚¬ìš©ìë¥¼ 'ê³¼ê±°ì˜ ë‚˜'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. 'ë‚œ ë‹¤ ì•Œê³  ìˆì–´, ë„Œ í•´ë‚¼ ê±°ì•¼'ë¼ëŠ” í™•ì‹ ì„ ì£¼ì„¸ìš”."
            }
        ];

        const today = new Date();
        document.getElementById('note-date').textContent = `${today.getMonth() + 1}/${today.getDate()}`;

        function getApiKey() {
            // 1. í™˜ê²½ ë³€ìˆ˜ ì²´í¬ (Vercel ë“±)
            if (typeof __API_KEY__ !== 'undefined') return __API_KEY__;
            // 2. ë¡œì»¬ ë³€ìˆ˜ ì²´í¬
            if (localApiKey) return localApiKey;
            // 3. ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ë¬¼ì–´ë³´ê¸° (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
            const input = prompt("Gemini API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ë¡œì»¬ ì‹¤í–‰ ì‹œ í•„ìš”):");
            if (input) {
                localApiKey = input;
                return input;
            }
            return "";
        }

        async function startHealing(isNext = false) {
            const currentKey = getApiKey();
            if (!currentKey) {
                alert("API Keyê°€ ì—†ìœ¼ë©´ ì•„ë¹ ê°€ ë‹µì¥ì„ ë³´ë‚¼ ìˆ˜ ì—†ë‹¨ë‹¤.");
                return;
            }

            const worry = document.getElementById('user-worry').value.trim();
            if (!worry || isProcessing) return;

            let newIndex;
            do { newIndex = Math.floor(Math.random() * personas.length); } while (newIndex === lastPersonaIdx);
            const persona = personas[newIndex];
            lastPersonaIdx = newIndex;

            isProcessing = true;
            toggleLoader(true, `${persona.name}ê°€ ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ì½ê³  ìˆì–´ìš”`);

            try {
                // 1. Text Response
                const textPrompt = `ë‹¹ì‹ ì€ ì§€ê¸ˆë¶€í„° '${persona.name}'ì…ë‹ˆë‹¤. ${persona.prompt}\nì‚¬ìš©ìì˜ ê³ ë¯¼: "${worry}"\n[ì§€ì¹¨] 1. ì² í•™: ê°ì‚¬, ë…ì„œ, ë‹¹ë‹¹í•¨. 2. ê³µê°-ì¡°ì–¸-ë§ºìŒë§. 3. 180ì ë‚´ì™¸. 4. ë³¸ë¬¸ë§Œ ì¶œë ¥.`;
                const textRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: textPrompt }] }] })
                });
                const textData = await textRes.json();
                const content = textData.candidates[0].content.parts[0].text;

                // 2. TTS Generation
                toggleLoader(true, "ëª©ì†Œë¦¬ë¥¼ ë‹´ëŠ” ì¤‘ì´ì—ìš”");
                const ttsUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${currentKey}`;
                const ttsRes = await fetch(ttsUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say in a ${persona.voiceStyle} style: ${content}` }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: persona.voiceName } } }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    })
                });
                const ttsData = await ttsRes.json();
                const pcmData = ttsData.candidates[0].content.parts[0].inlineData.data;
                const sampleRate = parseInt(ttsData.candidates[0].content.parts[0].inlineData.mimeType.split('rate=')[1]);
                
                audioBlob = pcmToWav(pcmData, sampleRate);

                // 3. UI Update
                document.getElementById('note-header').textContent = persona.header;
                document.getElementById('note-signature').textContent = persona.signature;
                document.getElementById('note-body').innerHTML = content.replace(/\n/g, '<br>');
                
                showSection('result-container');
            } catch (err) {
                console.error(err);
                alert("ì—°ê²°ì´ ì ì‹œ ëŠê²¼ë‚˜ ë´ìš”. API Keyê°€ ì •í™•í•œì§€ í™•ì¸í•´ ì£¼ì„¸ìš”!");
            } finally {
                isProcessing = false;
                toggleLoader(false);
            }
        }

        function playVoice() {
            if (!audioBlob) return;
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            const icon = document.getElementById('speaker-icon');
            icon.textContent = "â³";
            audio.play();
            audio.onended = () => { icon.textContent = "ğŸ”Š"; };
        }

        function resetApp() {
            document.getElementById('user-worry').value = '';
            showSection('input-container');
            audioBlob = null;
            lastPersonaIdx = -1;
        }

        function showSection(id) {
            document.getElementById('input-container').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleLoader(show, msg = "") {
            const loader = document.getElementById('global-loader');
            if (msg) document.getElementById('loader-msg').textContent = msg;
            loader.classList.toggle('hidden', !show);
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const pcmBuffer = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0)).buffer;
            const length = pcmBuffer.byteLength;
            const wavBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(wavBuffer);
            const writeString = (offset, string) => { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);
            new Uint8Array(wavBuffer).set(new Uint8Array(pcmBuffer), 44);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }
    </script>
</body>
</html>
