<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soul Healer | ì˜í˜¼ì˜ ìª½ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Outfit:wght@300;400;600&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f172a;
            --post-it: #fef9a7;
            --tape: rgba(255, 255, 255, 0.4);
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-deep);
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .handwriting { font-family: 'Nanum Pen Script', cursive; }
        .mystic-bg {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a),
                        radial-gradient(circle at bottom left, #312e81, #0f172a);
        }
        .post-it {
            background-color: var(--post-it);
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.5);
            transform: rotate(-1.5deg);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .post-it:hover { transform: rotate(0deg) scale(1.02); }
        .tape {
            background-color: var(--tape);
            width: 120px; height: 35px;
            position: absolute; top: -18px; left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .fade-in { animation: fadeIn 1.2s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
    </style>
</head>
<body class="mystic-bg min-h-screen flex items-center justify-center p-6">

    <div class="w-full max-w-lg z-10">
        <!-- Main Interface -->
        <div id="input-container" class="fade-in space-y-10">
            <header class="text-center">
                <h1 class="text-3xl font-light tracking-[0.3em] text-indigo-300 mb-2 uppercase">Soul Healer</h1>
                <p class="text-indigo-200/40 text-[10px] tracking-widest uppercase">Random Persona Edition</p>
            </header>

            <div class="bg-white/5 backdrop-blur-xl border border-white/10 rounded-[40px] p-10 shadow-2xl">
                <p class="text-indigo-100/70 mb-8 text-center text-sm font-light italic leading-relaxed">
                    "ì˜¤ëŠ˜ ê·¸ëŒ€ì˜ ë§ˆìŒì´ ì–´ë– í•œê°€ìš”? <br> ëˆ„êµ°ê°€ì—ê²Œ í„¸ì–´ë†“ì•„ ë³´ì„¸ìš”."
                </p>
                <textarea id="user-worry" rows="3" 
                    class="w-full bg-transparent border-b border-indigo-500/20 text-white text-center text-xl placeholder-indigo-300/10 focus:outline-none focus:border-indigo-400 transition-all resize-none mb-10"
                    placeholder="ì‚¬ì‹¤ ì € ì˜¤ëŠ˜ ì¢€ ì§€ì³¤ì–´ìš”..."></textarea>
                
                <button onclick="askHealer()" id="btn-submit"
                    class="w-full py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold tracking-widest hover:shadow-lg hover:shadow-indigo-500/30 transition-all active:scale-95 group">
                    ìª½ì§€ ë‚¨ê¸°ê¸°
                </button>
            </div>
        </div>

        <!-- Result View (Post-it) -->
        <div id="result-container" class="hidden flex flex-col items-center">
            <div id="healer-note" class="post-it relative p-10 w-full min-h-[450px] flex flex-col justify-between text-gray-800">
                <div class="tape"></div>
                
                <div class="flex justify-between items-start handwriting text-2xl text-blue-700/70">
                    <span id="note-header">ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ ì•„ì´ì—ê²Œ,</span>
                    <span id="note-date" class="text-gray-400 text-lg"></span>
                </div>

                <div id="note-body" class="handwriting text-3xl leading-[1.6] py-6 flex-grow overflow-y-auto">
                    <!-- Wisdom injected here -->
                </div>

                <div class="flex justify-between items-end">
                    <button id="btn-play" onclick="playVoice()" class="w-12 h-12 bg-black/5 hover:bg-black/10 rounded-full flex items-center justify-center transition-all">
                        <span id="speaker-icon" class="text-xl">ğŸ”Š</span>
                    </button>
                    <div class="text-right">
                        <span id="note-signature" class="handwriting text-4xl text-red-500/80"></span>
                    </div>
                </div>
            </div>

            <!-- New Button Group -->
            <div class="mt-12 flex flex-col sm:flex-row gap-4 w-full">
                <button onclick="resetApp()" 
                    class="flex-1 px-6 py-3 bg-white/5 hover:bg-white/10 text-indigo-200 border border-white/10 rounded-2xl text-xs font-medium tracking-widest uppercase transition-all">
                    ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <button onclick="askHealer()" 
                    class="flex-1 px-6 py-3 bg-indigo-600/30 hover:bg-indigo-600/50 text-white border border-indigo-500/30 rounded-2xl text-xs font-bold tracking-widest uppercase shadow-lg shadow-indigo-900/20 transition-all transform hover:-translate-y-0.5">
                    ë‹¤ë¥¸ ë©”ì‹œì§€ ë“£ê¸°
                </button>
            </div>
        </div>

        <!-- Global Loader -->
        <div id="global-loader" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin mb-4"></div>
            <p id="loader-msg" class="text-indigo-300 text-xs tracking-[0.2em] font-light uppercase loading-dots">ëˆ„êµ°ê°€ ë‹µì¥ì„ ì“°ê³  ìˆì–´ìš”</p>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        let audioBlob = null;
        let isGenerating = false;
        let currentPersona = null;

        const personas = [
            {
                name: "ë‹¤ì •í•œ ì•„ë¹ ",
                header: "ì‚¬ë‘í•˜ëŠ” ìš°ë¦¬ ë”¸ì—ê²Œ,",
                signature: "papa.",
                voiceStyle: "ë”°ëœ»í•˜ê³  ì¸ìí•œ ì•„ë¹ ì˜ ëª©ì†Œë¦¬",
                voiceName: "Fenrir",
                promptAdd: "ì‚¬ìš©ìë¥¼ 'ì„¸ìƒì—ì„œ ê°€ì¥ ì†Œì¤‘í•œ 7ì‚´ ë”¸'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ë§íˆ¬ëŠ” ~í•˜ë ´, ~ë‹¨ë‹¤."
            },
            {
                name: "í¬ê·¼í•œ ì—„ë§ˆ",
                header: "ë‚˜ì˜ ì˜ˆìœ ê°•ì•„ì§€ì—ê²Œ,",
                signature: "mom.",
                voiceStyle: "ë‹¤ì •í•˜ê³  ë¶€ë“œëŸ¬ìš´ ì—„ë§ˆì˜ ëª©ì†Œë¦¬",
                voiceName: "Kore",
                promptAdd: "ì‚¬ìš©ìë¥¼ 'ëˆˆì— ë„£ì–´ë„ ì•ˆ ì•„í”ˆ ìì‹'ìœ¼ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ë§íˆ¬ëŠ” ~í•´, ~í–ˆë‹ˆ?, ì—„ë§ˆê°€ í•­ìƒ ì‚¬ë‘í•´."
            },
            {
                name: "ì§€í˜œë¡œìš´ í• ë¨¸ë‹ˆ",
                header: "ê·€í•œ ìš°ë¦¬ ê°•ì•„ì§€ ë³´ì•„ë¼,",
                signature: "Grandma.",
                voiceStyle: "ì„¸ì›”ì´ ë¬»ì–´ë‚˜ëŠ” ì¸ìí•˜ê³  ëŠë¦¿í•œ í• ë¨¸ë‹ˆ ëª©ì†Œë¦¬",
                voiceName: "Leda",
                promptAdd: "ì‚¬ìš©ìë¥¼ 'ì• í‹‹í•œ ì†ì£¼'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. íˆ¬ë°•í•˜ì§€ë§Œ ë”°ëœ»í•œ ë§íˆ¬, ~í–ˆë‹ˆ?, ê³ ìƒ ë§ì•˜ë‹¤."
            },
            {
                name: "ìˆ˜í˜¸ì²œì‚¬",
                header: "ì§€ìƒì—ì„œ ë¹›ë‚˜ëŠ” ì˜í˜¼ì—ê²Œ,",
                signature: "Angel.",
                voiceStyle: "ì‹ ë¹„ë¡­ê³  ëª½í™˜ì ì´ë©° í‰ì˜¨í•œ ëª©ì†Œë¦¬",
                voiceName: "Aoede",
                promptAdd: "ì‚¬ìš©ìë¥¼ 'ë³´í˜¸ë°›ì•„ì•¼ í•  ì¡´ê·€í•œ ì˜í˜¼'ìœ¼ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. ê²©ì‹ ìˆê³  í‰ì˜¨í•œ ë§íˆ¬."
            },
            {
                name: "ë¯¸ë˜ì˜ ë‚˜",
                header: "ê³¼ê±°ë¥¼ ê²¬ë””ê³  ìˆëŠ” ë‚˜ì—ê²Œ,",
                signature: "Future Me.",
                voiceStyle: "ì°¨ë¶„í•˜ê³  í™•ì‹ ì— ì°¬ ì Šì€ ì„±ì¸ì˜ ëª©ì†Œë¦¬",
                voiceName: "Zephyr",
                promptAdd: "ì‚¬ìš©ìë¥¼ 'ê³¼ê±°ì˜ ë‚˜'ë¡œ ëŒ€í•˜ë©° ì‘ë‹µí•˜ì„¸ìš”. 'ë‚œ ë‹¤ ì•Œê³  ìˆì–´, ë„Œ ê²°êµ­ í•´ë‚¼ ê±°ì•¼'ë¼ëŠ” í™•ì‹ ì„ ì£¼ì„¸ìš”."
            }
        ];

        // Initialize Date
        const today = new Date();
        document.getElementById('note-date').textContent = `${today.getMonth() + 1}/${today.getDate()}`;

        async function askHealer() {
            const worryInput = document.getElementById('user-worry');
            const worry = worryInput.value.trim();
            if (!worry || isGenerating) return;

            // Randomly select persona
            currentPersona = personas[Math.floor(Math.random() * personas.length)];

            isGenerating = true;
            toggleLoader(true, `${currentPersona.name}ê°€ ë‹¹ì‹ ì„ ìƒê°í•˜ê³  ìˆì–´ìš”`);

            const textPrompt = `
                ë‹¹ì‹ ì€ ì§€ê¸ˆë¶€í„° '${currentPersona.name}'ì…ë‹ˆë‹¤. 
                ${currentPersona.promptAdd}
                
                ì‚¬ìš©ìì˜ ê³ ë¯¼: "${worry}"
                
                [ìª½ì§€ ì‘ì„± ì§€ì¹¨]
                1. ì² í•™: ëª¨ë“  ì¼ì— ê°ì‚¬í•˜ê¸°, ë°”ë¥¸ ë§ˆìŒì„ ìœ„í•œ ë…ì„œ, ì–¸ì œë‚˜ ë‹¹ë‹¹í•˜ê³  ë°ê²Œ í–‰ë™í•˜ê¸°.
                2. êµ¬ì¡°: ê³ ë¯¼ì— ëŒ€í•œ ê¹Šì€ ê³µê° -> ê° í˜ë¥´ì†Œë‚˜ì˜ ì„±ê²©ì´ ë‹´ê¸´ ì¡°ì–¸ -> ë”°ëœ»í•œ ë§ºìŒë§.
                3. ê¸¸ì´: í¬ìŠ¤íŠ¸ì‡ í•œ ì¥ ë¶„ëŸ‰ (ì•½ 150~200ì).
                4. ì¶œë ¥ í˜•ì‹: ì˜¤ì§ ìª½ì§€ ë‚´ìš©ë§Œ ì¶œë ¥í•˜ê³  ì„œëª…ì€ ìƒëµí•  ê²ƒ.
            `;

            try {
                // 1. Generate Text
                const textResponse = await callGeminiAPI("gemini-2.5-flash-preview-09-2025", {
                    contents: [{ parts: [{ text: textPrompt }] }]
                });
                const responseText = textResponse.candidates[0].content.parts[0].text;

                // 2. Generate Voice
                toggleLoader(true, "ëª©ì†Œë¦¬ë¥¼ ë‹´ëŠ” ì¤‘ì´ì—ìš”");
                await generateVoice(responseText, currentPersona);

                // 3. UI Update
                document.getElementById('note-header').textContent = currentPersona.header;
                document.getElementById('note-signature').textContent = currentPersona.signature;
                renderNote(responseText);
                showSection('result-container');
            } catch (err) {
                console.error(err);
                alert("í†µì‹ ì´ ì ì‹œ ë¶ˆì•ˆì •í•˜ë„¤ìš”. ë‹¤ì‹œ í•œë²ˆ ë“¤ë ¤ì£¼ì‹œê² ì–´ìš”?");
            } finally {
                isGenerating = false;
                toggleLoader(false);
            }
        }

        async function generateVoice(text, persona) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `ë‹¤ìŒ ë‚´ìš©ì„ ${persona.voiceStyle}ë¡œ ë‚˜ì§€ë§‰í•˜ê²Œ ì½ì–´ì¤˜: ${text}` }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: { prebuiltVoiceConfig: { voiceName: persona.voiceName } }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                })
            });

            const result = await response.json();
            const pcmData = result.candidates[0].content.parts[0].inlineData.data;
            const sampleRate = parseInt(result.candidates[0].content.parts[0].inlineData.mimeType.split('rate=')[1]);
            
            audioBlob = pcmToWav(pcmData, sampleRate);
        }

        function playVoice() {
            if (!audioBlob) return;
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            const icon = document.getElementById('speaker-icon');
            
            icon.textContent = "â³";
            audio.play();
            audio.onended = () => { icon.textContent = "ğŸ”Š"; };
        }

        async function callGeminiAPI(model, payload) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('API Error');
            return await response.json();
        }

        function renderNote(text) {
            const body = document.getElementById('note-body');
            body.innerHTML = text.replace(/\n/g, '<br>');
        }

        function resetApp() {
            document.getElementById('user-worry').value = '';
            showSection('input-container');
            audioBlob = null;
        }

        function showSection(id) {
            document.getElementById('input-container').classList.add('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }

        function toggleLoader(show, msg = "") {
            const loader = document.getElementById('global-loader');
            const loaderMsg = document.getElementById('loader-msg');
            if (msg) loaderMsg.textContent = msg;
            loader.classList.toggle('hidden', !show);
        }

        function pcmToWav(base64Pcm, sampleRate) {
            const pcmBuffer = Uint8Array.from(atob(base64Pcm), c => c.charCodeAt(0)).buffer;
            const length = pcmBuffer.byteLength;
            const wavBuffer = new ArrayBuffer(44 + length);
            const view = new DataView(wavBuffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length, true);
            const pcmView = new Uint8Array(pcmBuffer);
            const wavView = new Uint8Array(wavBuffer);
            wavView.set(pcmView, 44);
            return new Blob([wavBuffer], { type: 'audio/wav' });
        }
    </script>
</body>
</html>